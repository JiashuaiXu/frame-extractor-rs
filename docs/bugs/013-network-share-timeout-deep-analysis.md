# Bug #013: 网络共享文件获取视频信息超时深度分析

## 问题现象

处理网络共享（Samba）上的视频文件时，在"执行 FFmpeg 获取视频信息..."步骤超时（30-60秒）。

### 日志输出
```
15:08:35.304 执行 FFmpeg 获取视频信息...
[60秒后]
超时60s
```

## 问题根本原因分析

### 1. FFmpeg 获取视频信息的工作原理

FFmpeg 获取视频信息需要：
1. **读取文件头**：解析容器格式（MP4、AVI等）的元数据
2. **解析流信息**：读取视频流和音频流的编码信息
3. **计算时长**：某些格式需要扫描文件才能确定精确时长

**关键问题**：
- 对于 MP4 文件，时长信息通常在文件头（`moov` atom）中
- 但如果 `moov` atom 在文件末尾（某些编码器会这样），FFmpeg 需要读取整个文件
- 对于网络文件，这意味着需要通过网络传输整个文件

### 2. 网络文件访问的特殊性

**Samba/UNC 路径的特点**：
- 网络延迟：每次读取都有网络往返时间（RTT）
- 带宽限制：网络带宽通常远低于本地磁盘
- 连接稳定性：网络可能不稳定，导致重传
- 缓存机制：Windows 网络文件系统有缓存，但首次访问仍需要网络传输

**实际影响**：
- 即使限制探测大小为 2MB，如果网络带宽只有 1Mbps，读取 2MB 需要约 16 秒
- 如果网络不稳定，可能需要多次重传，时间更长
- 如果 `moov` atom 在文件末尾，可能需要读取整个文件（可能几GB）

### 3. 当前实现的局限性

**当前参数设置**：
```rust
"-analyzeduration", "10000000",  // 10 秒（微秒）
"-probesize", "10000000",        // 10MB（字节）
```

**问题**：
1. **探测大小太大**：10MB 对于网络文件来说太大，即使网络正常也需要较长时间
2. **没有读取速度限制**：FFmpeg 可能尝试以最大速度读取，导致网络拥塞
3. **超时时间过长**：60秒太长，用户等待体验差
4. **没有降级方案**：超时后直接失败，没有替代方案

## 优化方案

### 方案 1: 优化 FFmpeg 参数（已实施）

**改进的参数**：
```rust
"-analyzeduration", "5000005",   // 5 秒（微秒）- 更短
"-probesize", "2097152",        // 2MB（字节）- 更小，只读取文件头
"-readrate", "10M",             // 限制读取速度为 10MB/s
```

**优势**：
- 更小的探测大小：只读取文件头，大多数 MP4 文件的元数据在文件头
- 读取速度限制：避免网络拥塞
- 更短的超时：30秒，如果30秒内无法读取2MB，说明网络有问题

### 方案 2: 降级处理（已实施）

**实现**：
- 如果获取视频信息超时，使用默认值继续处理
- 默认值：1小时时长，30fps
- 虽然可能不准确，但至少可以让处理继续

**代码**：
```rust
if is_network {
    emit_log(app, "warn", "尝试使用降级方案：跳过视频信息获取，使用估算值...");
    return Ok((3600.0, 30.0)); // 默认1小时，30fps
}
```

### 方案 3: 跳过信息获取（可选）

**思路**：
- 对于网络文件，直接开始提取帧
- FFmpeg 在提取帧时会自动获取必要的信息
- 缺点：无法预先知道视频时长，无法准确计算帧数

**实现**（未实施，可作为备选）：
```rust
// 对于网络文件，如果获取信息失败，直接开始提取
// 使用 -t 参数限制处理时间，避免处理整个文件
```

### 方案 4: 使用 FFprobe（如果可用）

**FFprobe 的优势**：
- 专门用于获取媒体信息，比 FFmpeg 更快
- 可以只读取元数据，不处理视频流
- 但需要确保 FFprobe 可用

**实现**（未实施）：
```rust
// 尝试使用 ffprobe 获取信息
// 如果失败，回退到 ffmpeg
```

## 处理流程分析

### 当前流程

```
1. 检测网络路径
   ↓
2. 设置优化的 FFmpeg 参数
   - analyzeduration: 5秒
   - probesize: 2MB
   - readrate: 10MB/s
   ↓
3. 执行 FFmpeg 命令（30秒超时）
   ↓
4a. 成功 → 解析时长和FPS → 继续处理
4b. 超时 → 使用降级方案（默认值）→ 继续处理
4c. 错误 → 返回错误
```

### 优化后的流程

```
1. 检测网络路径
   ↓
2. 设置优化的 FFmpeg 参数（更激进）
   ↓
3. 执行 FFmpeg 命令（30秒超时）
   ↓
4a. 成功 → 解析时长和FPS → 继续处理
4b. 超时 → 
    - 记录警告
    - 使用默认值（1小时，30fps）
    - 继续处理（虽然帧数计算可能不准确）
4c. 错误 → 返回错误
```

## 性能对比

| 方案 | 探测大小 | 超时时间 | 网络要求 | 准确性 |
|------|---------|---------|---------|--------|
| 原始方案 | 10MB | 60秒 | 高 | 高 |
| 优化方案1 | 2MB | 30秒 | 中 | 高 |
| 降级方案 | 2MB | 30秒 | 低 | 中（使用默认值）|

## 最佳实践建议

### 对于网络文件

1. **优先方案**：将文件复制到本地再处理
   - 优点：速度快，稳定，准确
   - 缺点：需要额外存储空间

2. **次优方案**：使用优化的参数
   - 优点：不需要复制文件
   - 缺点：可能超时，需要稳定的网络

3. **备选方案**：使用降级处理
   - 优点：即使超时也能继续处理
   - 缺点：帧数计算可能不准确

### 网络要求

- **最低要求**：稳定带宽 ≥ 2Mbps
- **推荐要求**：稳定带宽 ≥ 10Mbps
- **超时阈值**：30秒内无法读取2MB，说明网络不适合直接处理

## 代码变更总结

### 文件：`src-tauri/src/extractor.rs`

1. **优化 FFmpeg 参数**：
   - `-analyzeduration`: 10秒 → 5秒
   - `-probesize`: 10MB → 2MB
   - 新增 `-readrate`: 10MB/s

2. **缩短超时时间**：
   - 网络文件：60秒 → 30秒
   - 本地文件：30秒 → 15秒

3. **添加降级方案**：
   - 超时后使用默认值继续处理
   - 记录警告信息

## 测试建议

### 测试场景

1. **正常网络**（≥10Mbps）：
   - 应该能在30秒内完成
   - 验证：日志显示成功获取信息

2. **慢速网络**（1-5Mbps）：
   - 可能超时，但会使用降级方案
   - 验证：日志显示警告，但处理继续

3. **不稳定网络**：
   - 可能超时或失败
   - 验证：错误信息清晰

### 验证点

- ✅ 正常网络能快速获取信息
- ✅ 慢速网络能使用降级方案
- ✅ 超时后处理能继续（虽然可能不准确）
- ✅ 错误信息清晰明确

## 后续优化方向

1. **智能重试**：超时后重试一次，使用更小的探测大小
2. **进度反馈**：显示 FFmpeg 的读取进度
3. **缓存机制**：缓存已获取的视频信息
4. **并行处理**：对于多个视频，可以并行获取信息

## 相关文档

- [FFmpeg 参数文档](https://ffmpeg.org/ffmpeg.html)
- [MP4 文件格式](https://en.wikipedia.org/wiki/MP4_file_format)
- [Samba 性能优化](https://www.samba.org/samba/docs/current/man-html/smb.conf.5.html)

## 状态

✅ 已优化（方案1 + 方案2）

## 修复日期

2025-11-07

